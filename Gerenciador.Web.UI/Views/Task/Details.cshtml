@model Gerenciador.Domain.Task

@{
    ViewBag.Title = "Details";
}

<section class="content invoice">
    <!-- title row -->
    <div class="row">
        <div class="col-xs-12">
            <h2 class="page-header">
                <i class="fa fa-file-text-o"> @Model.Name</i> 
                <span id="taskStatus" class="label label-@(Model.IsDone() ? "success" : "warning")">
                    @Html.Raw(Model.IsDone() ? "Completed" : "Pending")
                </span>
                <small class="pull-right">Data de Hoje: @DateTime.Now </small>
            </h2>
            <div class="progress progress">
                <div id="taskUpdateBar" class="progress-bar progress-bar-primary" role="progressbar" aria-valuenow="@Model.Progress" aria-valuemin="0" aria-valuemax="100" style="width: @Model.Progress%">
                    <span id="progressLegend"><strong>@Model.Progress% Completo</strong></span>
                </div>
            </div>
        </div><!-- /.col -->
    </div>
    <!-- info row -->
    <div class="row invoice-info">
        <div class="col-sm-4 invoice-col">
            <strong>Início </strong><br />
            Criado: <strong>@Model.CreatedAt</strong><br>
            Iniciado: <strong>@DateTime.Now</strong><br />
            <strong>Término</strong><br>
            Expectativa inicial: <strong>xxxxx</strong> <br>
            Data de término: <strong>xxxx</strong><br>
            Variação: <strong>+/- 3 dias</strong>
        </div><!-- /.col -->

        <div class="col-sm-4 invoice-col">
            <div class="box box-solid bg-light-blue-gradient">
                <div class="box-body no-padding">
                    <!--The calendar -->
                    <div id="calendar" style="width: 100%"></div>
                </div><!-- /.box-body -->
            </div>            
        </div><!-- /.col -->

        <div class="col-sm-4 invoice-col">
            <strong>Ações </strong><br />
            <a class="btn btn-app">
                <i class="fa fa-edit"></i> Conteúdo
            </a>
            <button class="btn btn-app" data-toggle="modal" data-target="#modalUpdateProgress">
                <i class="fa fa-play"></i> Progresso
            </button>
            <a class="btn btn-app">
                <i class="fa fa-arrow-circle-o-right"></i> Sub-tarefa
            </a>
            <button class="btn btn-app" data-toggle="modal" data-target="#modalCreateComment">
                <i class="fa fa-bullhorn"></i> Comentário
            </button>
        </div><!-- /.col -->
    </div><!-- /.row -->    

    <br />

    <div class="row">
        <div class="col-md-12">
            <blockquote>@Html.DisplayFor(x => x.Description)</blockquote> 
        </div>
    </div>

    <!-- Table row -->
    <h2>Micro tarefas</h2>
    <div class="row">
        <div class="col-xs-12 table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Name</th>
                        <th>Data de início</th>
                        <th>Data fim</th>
                        <th>Terminada?</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>3dc22228-851e-4611-b33d-d96f4f9c53aa</td>
                        <td>Sub tarefa 1</td>
                        <td>13/10/2014</td>
                        <td>16/10/2014</td>
                        <td>Sim</td>
                    </tr>
                    <tr>
                        <td>3dc22228-851e-4611-b33d-d96f4f9c53aa</td>
                        <td>Sub tarefa 2</td>
                        <td>13/10/2014</td>
                        <td>16/10/2014</td>
                        <td>Sim</td>
                    </tr>
                    <tr>
                        <td>3dc22228-851e-4611-b33d-d96f4f9c53aa</td>
                        <td>Sub tarefa 3</td>
                        <td>13/10/2014</td>
                        <td>16/10/2014</td>
                        <td>Não</td>
                    </tr>
                    <tr>
                        <td>3dc22228-851e-4611-b33d-d96f4f9c53aa</td>
                        <td>Sub tarefa 4</td>
                        <td>13/10/2014</td>
                        <td>16/10/2014</td>
                        <td>Não</td>
                    </tr>
                </tbody>
            </table>
        </div><!-- /.col -->
    </div><!-- /.row -->

    <div class="row">
        <!-- accepted payments column -->
        <div class="col-md-6">
            <div id="taskComments">
            </div>
        </div><!-- /.col -->
        <div class="col-md-6">
            <div id="taskTimeline"></div>
            @*@Html.Partial("~/Views/Task/_TaskTimelineWidget.cshtml")*@
        </div><!-- /.col -->
    </div><!-- /.row -->

    <!-- this row will not appear when printing -->
    <div class="row no-print">
        <div class="col-xs-12">
            <button class="btn btn-default pull-right" onclick="window.print();"><i class="fa fa-print"></i> Print</button>
            <button class="btn btn-success pull-right"><i class="fa fa-credit-card"></i> Edit</button>
            <button class="btn btn-primary pull-right" style="margin-right: 5px;"><i class="fa fa-download"></i> Generate PDF</button>
        </div>
    </div>
</section>

<p>
    @Html.ActionLink("Edit", "Edit", new { id=Model.Id }) |
    @Html.ActionLink("Back to List", "Index")
</p>

<!-- Modal -->
<div class="modal fade" id="modalUpdateProgress" tabindex="-1" role="dialog" aria-labelledby="modalUpdateProgressLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fechar</span></button>
                <h4 class="modal-title" id="modalUpdateProgressLabel">Progresso</h4>
            </div>
            <div class="modal-body">
               <input id="progressUpdaterSlider" type="text" value="" class="slider form-control" data-slider-min="0" data-slider-max="100" data-slider-step="5" data-slider-value="@Model.Progress" data-slider-orientation="horizontal" data-slider-selection="before" data-slider-tooltip="show" data-slider-id="blue">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                <button id="btnProgressSave" type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCreateComment" tabindex="-1" role="dialog" aria-labelledby="modalCreateCommentLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Fechar</span></button>
                <h4 class="modal-title" id="modalCreateCommentLabel">Comentário</h4>
            </div>
            <div class="modal-body">
            <div class="box box-warning">
                <div class="box-header">
                    <h3 class="box-title">Escrever comentário</h3>
                </div><!-- /.box-header -->
                <div class="box-body">
                        <!-- text input -->
                        <div class="form-group">
                            Comentário: <br />
                            ​<textarea id="txtComment" rows="10" style="width:100%"></textarea>
                        </div>
                </div><!-- /.box-body -->
            </div><!-- /.box -->
        </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                <button id="btnCreateComment" type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>



@section scripts{
    <script type="text/javascript">
        $("#calendar").datepicker({
            language: "pt-BR",
            format: 'dd/mm/yyyy',
            beforeShowDay: function (date) {
                var day = '@Model.CreatedAt.Day';
                //console.log(day);
                //console.log(date);
                //console.log(date.getMonth());
                //console.log(date.getDate());
                if (date.getMonth() == (new Date()).getMonth()) {
                    switch (date.getDate()) {
                        case 4:
                            return {
                                tooltip: 'Example tooltip',
                                classes: 'active'
                            };
                        case 8:
                            return false;
                        case 12:
                            return "green";
                    }
                }
            }
        });
        $('.slider').slider();

        $(document).ready(function () {            
            var _projectId = '@(Model.ProjectId)';
            var _id = '@(Model.Id)';
            LoadComments(_projectId, _id);
            LoadTimeline();

            //Async Populates Comments 
            function LoadComments(_projectId, _taskId) {
                this.dataToSend = { projectId: _projectId, taskId: _taskId };
                $.ajax({
                    url: '@Url.Action("Index", "Comments")',
                    data: this.dataToSend,
                    contentType: 'application/html; charset=utf-8',
                    type: 'GET',
                    dataType: 'html'
                })
                .success(function (result) {
                    $('#taskComments').html(result);
                })
                .error(function (xhr, status) {
                    alert('erro status: ' + status);
                });
            }

            //async populates timeline
            function LoadTimeline() {
                $.ajax({
                    url: '@Url.Action("GetTimeline", "Task", new { taskId = @Model.Id })',
                    contentType: 'application/html; charset=utf-8',
                    type: 'GET',
                    dataType: 'html'
                })
                .success(function (result) {
                    $('#taskTimeline').html(result);
                })
                .error(function (xhr, status) {
                    alert('erro status: ' + status);
                });
            }

            //Update Progress
            $(".modal-footer").on("click", "#btnProgressSave", function () {
                this._projectId = '@(Model.ProjectId)';
                this._id = '@(Model.Id)';
                var _valueToUpdate = $('#progressUpdaterSlider')[0].value
                var posting = $.post('/Task/UpdateProgress', { projectId: _projectId, id: _id, newValue: _valueToUpdate });
                posting.done(function (data) {
                    var dataToUpdate = data + '%';
                    $('#modalUpdateProgress').modal('hide')
                    $('#taskUpdateBar').width(dataToUpdate);
                    $("#progressLegend").html($('<strong/>').append(dataToUpdate + ' Completo'));
                    $('#taskUpdateBar').attr('aria-valuenow', data);
                    if (data == 100) {
                        $('#taskStatus').attr("class", "label label-success").html('Completed');
                    } else {
                        $('#taskStatus').attr("class", "label label-warning").html('Pending');
                    }
                });                
            });

            //Create Comments
            $(".modal-footer").on("click", "#btnCreateComment", function () {
                this._projectId = '@(Model.ProjectId)';
                this._id = '@(Model.Id)';
                var posting = $.post('@Url.Action("Create", "Comments")', {
                    projectId: this._projectId,
                    taskId: this._id,
                    content: $('#txtComment').val()
                });
                posting.done(function (result) {
                    this._projectId = '@(Model.ProjectId)';
                    this._id = '@(Model.Id)';
                    $('#modalCreateComment').modal('hide');
                    $('#txtComment').val('');
                    LoadComments(this._projectId, this._id);
                    LoadTimeline();
                });
            });
        });
    </script>    
}
